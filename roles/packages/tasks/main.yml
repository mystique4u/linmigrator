---
# Package installation role - maps Ubuntu packages to Fedora equivalents

- name: Package installation banner
  debug:
    msg: |
      ╔════════════════════════════════════════════════════════════╗
      ║           Installing Packages                             ║
      ╚════════════════════════════════════════════════════════════╝

- name: Enable RPM Fusion repositories
  dnf:
    name:
      - "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_version }}.noarch.rpm"
      - "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_version }}.noarch.rpm"
    state: present
    disable_gpg_check: yes
  when: enable_rpmfusion | bool

- name: Update package cache
  dnf:
    update_cache: yes

- name: Install base system packages
  dnf:
    name:
      - vim
      - wget
      - curl
      - htop
      - tmux
      - screen
      - rsync
      - unzip
      - tar
      - git
      - ca-certificates
      - gnupg
      - lsb-release
    state: present

- name: Load Ubuntu package inventory
  set_fact:
    ubuntu_packages: "{{ ubuntu_system.packages.apt | default([]) }}"
  when: ubuntu_system is defined

- name: Map Ubuntu packages to Fedora equivalents
  set_fact:
    fedora_packages: |
      {% set pkg_map = {
        'build-essential': ['gcc', 'gcc-c++', 'make', 'kernel-devel'],
        'python3-pip': ['python3-pip'],
        'python3-dev': ['python3-devel'],
        'python3-venv': ['python3-virtualenv'],
        'libpython3-dev': ['python3-devel'],
        'nodejs': ['nodejs'],
        'npm': ['npm'],
        'docker.io': ['docker'],
        'docker-compose': ['docker-compose'],
        'postgresql': ['postgresql', 'postgresql-server'],
        'postgresql-client': ['postgresql'],
        'mysql-server': ['mysql-server'],
        'mysql-client': ['mysql'],
        'redis-server': ['redis'],
        'nginx': ['nginx'],
        'apache2': ['httpd'],
        'php': ['php'],
        'php-fpm': ['php-fpm'],
        'openssh-server': ['openssh-server'],
        'openssh-client': ['openssh-clients'],
        'net-tools': ['net-tools'],
        'dnsutils': ['bind-utils'],
        'sqlite3': ['sqlite'],
        'libsqlite3-dev': ['sqlite-devel'],
        'libssl-dev': ['openssl-devel'],
        'libcurl4-openssl-dev': ['libcurl-devel'],
        'libxml2-dev': ['libxml2-devel'],
        'libxslt1-dev': ['libxslt-devel'],
        'zlib1g-dev': ['zlib-devel'],
        'libbz2-dev': ['bzip2-devel'],
        'libreadline-dev': ['readline-devel'],
        'libncurses5-dev': ['ncurses-devel'],
        'libffi-dev': ['libffi-devel'],
        'libgdbm-dev': ['gdbm-devel'],
        'liblzma-dev': ['xz-devel'],
        'tk-dev': ['tk-devel'],
        'uuid-dev': ['libuuid-devel'],
        'fonts-liberation': ['liberation-fonts'],
        'fonts-dejavu': ['dejavu-fonts'],
        'gnome-tweaks': ['gnome-tweaks'],
        'gnome-shell-extensions': ['gnome-shell-extensions'],
        'chrome-gnome-shell': ['chrome-gnome-shell'],
        'code': ['code'],
        'firefox': ['firefox'],
        'chromium-browser': ['chromium'],
        'vlc': ['vlc'],
        'gimp': ['gimp'],
        'inkscape': ['inkscape'],
        'libreoffice': ['libreoffice'],
        'flatpak': ['flatpak']
      } %}
      {% set packages = [] %}
      {% for pkg in ubuntu_packages %}
      {%   if pkg.name in pkg_map %}
      {%     set _ = packages.extend(pkg_map[pkg.name]) %}
      {%   elif not pkg.name.startswith('linux-') and not pkg.name.startswith('lib') %}
      {%     set _ = packages.append(pkg.name) %}
      {%   endif %}
      {% endfor %}
      {{ packages | unique | list }}
  when: ubuntu_packages is defined and ubuntu_packages | length > 0

- name: Install mapped packages
  dnf:
    name: "{{ fedora_packages }}"
    state: present
  when: fedora_packages is defined and fedora_packages | length > 0
  ignore_errors: yes
  register: package_install

- name: Display package installation results
  debug:
    msg: |
      Package Installation:
      - Attempted: {{ fedora_packages | length if fedora_packages is defined else 0 }}
      - Status: {{ 'Success' if package_install is succeeded else 'Some packages failed (continuing)' }}

- name: Enable Flathub repository
  flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
  when: enable_flathub | bool

- name: Install Flatpak packages from Ubuntu
  flatpak:
    name: "{{ item.name }}"
    state: present
  loop: "{{ ubuntu_system.packages.flatpak | default([]) }}"
  when:
    - ubuntu_system is defined
    - enable_flathub | bool
  ignore_errors: yes

- name: Set package count for summary
  set_fact:
    packages_installed: "{{ fedora_packages | length if fedora_packages is defined else 0 }}"
